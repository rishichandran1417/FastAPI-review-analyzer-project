<!DOCTYPE html>
<html>
<head>
  <title>Analytics Dashboard - Amazon Review Analysis</title>
  <link rel="stylesheet" href="/static/style.css?v=2">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="container">
    <header>
      <h1>Analytics Dashboard</h1>
    </header>

    <nav class="nav-bar">
      <a href="/" class="nav-btn">
        <span class="nav-icon">Home</span>
      </a>
      <a href="/products" class="nav-btn">
        <span class="nav-icon">Products</span>
      </a>
      <a href="/dashboard" class="nav-btn active">
        <span class="nav-icon">Dashboard</span>
      </a>
      <a href="/clear" class="nav-btn clear-btn">
        <span class="nav-icon">Clear Data</span>
      </a>
    </nav>

    <div class="main-content">
      {% if stats %}
        <div class="stats-grid animated-dashboard">
          <div class="stat-card">
            <div class="stat-value">{{ stats.total }}</div>
            <div class="stat-label">Total Reviews</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">{{ stats.positive }}</div>
            <div class="stat-label">Positive Reviews</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">{{ stats.neutral }}</div>
            <div class="stat-label">Neutral Reviews</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">{{ stats.negative }}</div>
            <div class="stat-label">Negative Reviews</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">{{ "%.1f"|format(stats.avg_rating) }}</div>
            <div class="stat-label">Average Rating</div>
          </div>
        </div>

        {% if correlations %}
        <div class="grid-2 animated-dashboard">
          <div class="stat-card">
            <div class="stat-label" style="color: var(--primary-color);">Rating vs. Sentiment</div>
            <div class="stat-value">r = {{ correlations.rating_sentiment.r }}</div>
            <div style="color: var(--text-secondary); margin-top: 0.5rem; font-size: 0.95rem;">{{ correlations.rating_sentiment.text }}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label" style="color: var(--primary-color);">Rating vs. Length</div>
            <div class="stat-value">r = {{ correlations.rating_length.r }}</div>
            <div style="color: var(--text-secondary); margin-top: 0.5rem; font-size: 0.95rem;">{{ correlations.rating_length.text }}</div>
          </div>
        </div>
        {% endif %}

        <div class="grid-2">
          <div class="chart-container">
            <h3 class="chart-title">Sentiment Distribution</h3>
            <canvas id="sentimentChart"></canvas>
          </div>
          <div class="chart-container">
            <h3 class="chart-title">Rating Distribution</h3>
            <canvas id="ratingChart"></canvas>
          </div>
        </div>

        <div class="chart-container">
          <h3 class="chart-title">Sentiment vs Rating Analysis</h3>
          <canvas id="sentimentRatingChart" style="max-height: 300px;"></canvas>
        </div>

        <h2 class="section-title">Advanced Analysis (Matplotlib)</h2>
        <div class="grid-2">
          <div class="chart-container">
            <h3 class="chart-title">Review Length Distribution</h3>
            <img src="/plots/review_length" alt="Review Length Distribution" style="width: 100%; height: auto; border-radius: 8px;">
          </div>
          <div class="chart-container">
            <h3 class="chart-title">Sentiment Polarity Distribution</h3>
            <img src="/plots/sentiment_polarity" alt="Sentiment Polarity Distribution" style="width: 100%; height: auto; border-radius: 8px;">
          </div>
        </div>

        <!-- Review Length by Rating & Rating Spread in Single Row -->
        <div class="grid-2">
          <div class="chart-container">
            <h3 class="chart-title" style="text-align: center;">Review Length by Rating</h3>
            <p style="text-align: center; color: var(--text-secondary); margin-bottom: 1rem;">Do people write more when they are angry or happy?</p>
            <img src="/plots/length_by_rating" alt="Review Length by Rating" style="width: 100%; height: auto; border-radius: 8px;">
          </div>
          <div class="chart-container">
            <h3 class="chart-title" style="text-align: center;">Rating Spread & Variance</h3>
            <img src="/plots/rating_spread" alt="Rating Spread & Variance" style="width: 100%; height: auto; border-radius: 8px;">
          </div>
        </div>

        <!-- Sentiment Distribution and Advanced Metrics Tables -->
        {% if detailed_sentiment %}
        <h2 class="section-title">Statistical Analysis</h2>
        <div class="grid-2">
          <!-- Sentiment Distribution Table -->
          <div class="chart-container">
            <h3 class="chart-title">SENTIMENT DISTRIBUTION</h3>
            <table style="width: 100%; border-collapse: collapse; color: var(--text-primary);">
              <thead>
                <tr style="border-bottom: 2px solid var(--border-color);">
                  <th style="text-align: left; padding: 0.75rem; font-weight: 500;">Sentiment Class</th>
                  <th style="text-align: right; padding: 0.75rem; font-weight: 500;">Count</th>
                </tr>
              </thead>
              <tbody>
                <tr style="border-bottom: 1px solid var(--border-color);">
                  <td style="padding: 0.75rem;">Very Positive</td>
                  <td style="text-align: right; padding: 0.75rem; font-weight: 600;">{{ detailed_sentiment.very_positive }}</td>
                </tr>
                <tr style="border-bottom: 1px solid var(--border-color);">
                  <td style="padding: 0.75rem;">Positive</td>
                  <td style="text-align: right; padding: 0.75rem; font-weight: 600;">{{ detailed_sentiment.positive }}</td>
                </tr>
                <tr style="border-bottom: 1px solid var(--border-color);">
                  <td style="padding: 0.75rem;">Neutral</td>
                  <td style="text-align: right; padding: 0.75rem; font-weight: 600;">{{ detailed_sentiment.neutral }}</td>
                </tr>
                <tr style="border-bottom: 1px solid var(--border-color);">
                  <td style="padding: 0.75rem;">Negative</td>
                  <td style="text-align: right; padding: 0.75rem; font-weight: 600;">{{ detailed_sentiment.negative }}</td>
                </tr>
                <tr>
                  <td style="padding: 0.75rem;">Very Negative</td>
                  <td style="text-align: right; padding: 0.75rem; font-weight: 600;">{{ detailed_sentiment.very_negative }}</td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Advanced Disagreement Metrics Table -->
          {% if advanced_metrics %}
          <div class="chart-container">
            <h3 class="chart-title">ADVANCED DISAGREEMENT METRICS</h3>
            <table style="width: 100%; border-collapse: collapse; color: var(--text-primary); font-size: 0.9rem;">
              <thead>
                <tr style="border-bottom: 2px solid var(--border-color);">
                  <th style="text-align: left; padding: 0.6rem; font-weight: 500;">Metric</th>
                  <th style="text-align: right; padding: 0.6rem; font-weight: 500;">Star Rating</th>
                  <th style="text-align: right; padding: 0.6rem; font-weight: 500;">Sentiment Polarity</th>
                </tr>
              </thead>
              <tbody>
                <tr style="border-bottom: 1px solid var(--border-color);">
                  <td style="padding: 0.6rem;">Mean</td>
                  <td style="text-align: right; padding: 0.6rem;">{{ advanced_metrics.rating.mean }}</td>
                  <td style="text-align: right; padding: 0.6rem;">{{ advanced_metrics.polarity.mean }}</td>
                </tr>
                <tr style="border-bottom: 1px solid var(--border-color);">
                  <td style="padding: 0.6rem;">Median</td>
                  <td style="text-align: right; padding: 0.6rem;">{{ advanced_metrics.rating.median }}</td>
                  <td style="text-align: right; padding: 0.6rem;">{{ advanced_metrics.polarity.median }}</td>
                </tr>
                <tr style="border-bottom: 1px solid var(--border-color);">
                  <td style="padding: 0.6rem;">Std Deviation</td>
                  <td style="text-align: right; padding: 0.6rem;">{{ advanced_metrics.rating.std }}</td>
                  <td style="text-align: right; padding: 0.6rem;">{{ advanced_metrics.polarity.std }}</td>
                </tr>
                <tr style="border-bottom: 1px solid var(--border-color);">
                  <td style="padding: 0.6rem;">Variance</td>
                  <td style="text-align: right; padding: 0.6rem;">{{ advanced_metrics.rating.variance }}</td>
                  <td style="text-align: right; padding: 0.6rem;">{{ advanced_metrics.polarity.variance }}</td>
                </tr>
                <tr style="border-bottom: 1px solid var(--border-color);">
                  <td style="padding: 0.6rem;">Skewness</td>
                  <td style="text-align: right; padding: 0.6rem;">{{ advanced_metrics.rating.skewness }}</td>
                  <td style="text-align: right; padding: 0.6rem;">{{ advanced_metrics.polarity.skewness }}</td>
                </tr>
                <tr>
                  <td style="padding: 0.6rem;">Kurtosis</td>
                  <td style="text-align: right; padding: 0.6rem;">{{ advanced_metrics.rating.kurtosis }}</td>
                  <td style="text-align: right; padding: 0.6rem;">{{ advanced_metrics.polarity.kurtosis }}</td>
                </tr>
              </tbody>
            </table>
            {% if correlations %}
            <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
              <div style="font-size: 0.95rem; line-height: 1.6;">
                <div style="margin-bottom: 0.5rem;">
                  <strong style="color: var(--primary-color);">Pearson Correlation (Rating vs Sentiment):</strong> 
                  <span style="font-weight: 600;">{{ correlations.rating_sentiment.r }}</span>
                </div>
                <div style="color: var(--text-secondary); font-size: 0.85rem;">
                  P-Value: {{ correlations.rating_sentiment.p }}
                </div>
              </div>
            </div>
            {% endif %}
          </div>
          {% endif %}
        </div>
        {% endif %}

        <script>
        // Chart.js configuration with premium dark theme
        Chart.defaults.color = '#bdc1c6';
        Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.05)';
        Chart.defaults.font.family = "'Inter', sans-serif";
        Chart.defaults.plugins.legend.labels.usePointStyle = true;
        Chart.defaults.plugins.tooltip.backgroundColor = 'rgba(23, 28, 36, 0.9)';
        Chart.defaults.plugins.tooltip.titleColor = '#f8f9fa';
        Chart.defaults.plugins.tooltip.bodyColor = '#bdc1c6';
        Chart.defaults.plugins.tooltip.borderColor = 'rgba(255, 255, 255, 0.1)';
        Chart.defaults.plugins.tooltip.borderWidth = 1;
        Chart.defaults.plugins.tooltip.padding = 10;
        Chart.defaults.plugins.tooltip.cornerRadius = 8;
        
        // Sentiment Pie Chart
        const sentimentCtx = document.getElementById('sentimentChart').getContext('2d');
        new Chart(sentimentCtx, {
          type: 'doughnut',
          data: {
            labels: ['Positive', 'Neutral', 'Negative'],
            datasets: [{
              data: [{{ stats.positive }}, {{ stats.neutral }}, {{ stats.negative }}],
              backgroundColor: ['#81c784', '#64b5f6', '#e57373'], /* Soft Green, Soft Blue, Soft Red */
              borderColor: ['#1b5e20', '#0d47a1', '#b71c1c'], /* Darker borders for contrast */
              borderWidth: 0,
              hoverOffset: 4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '70%', /* Thinner doughnut */
            plugins: {
              legend: {
                position: 'bottom',
                labels: {
                  padding: 20,
                  font: {
                    size: 12
                  }
                }
              }
            }
          }
        });

        // Rating Bar Chart
        const ratingCtx = document.getElementById('ratingChart').getContext('2d');
        // Use real rating distribution from server
        const ratingData = {{ stats.stars | tojson }};

        new Chart(ratingCtx, {
          type: 'bar',
          data: {
            labels: ['1 Star', '2 Stars', '3 Stars', '4 Stars', '5 Stars'],
            datasets: [{
              label: 'Number of Reviews',
              data: ratingData,
              backgroundColor: [
                '#e57373',
                '#ffb74d',
                '#64b5f6',
                '#81c784',
                '#4caf50'
              ],
              borderRadius: 4,
              borderWidth: 0
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                grid: {
                  color: 'rgba(255, 255, 255, 0.05)',
                  drawBorder: false
                },
                ticks: {
                  color: '#bdc1c6'
                }
              },
              x: {
                grid: {
                  display: false
                },
                ticks: {
                  color: '#bdc1c6'
                }
              }
            }
          }
        });

        // Sentiment vs Rating Line Chart
        const sentimentRatingCtx = document.getElementById('sentimentRatingChart').getContext('2d');
        new Chart(sentimentRatingCtx, {
          type: 'line',
          data: {
            labels: ['1 Star', '2 Stars', '3 Stars', '4 Stars', '5 Stars'],
            datasets: [
              {
                label: 'Avg Sentiment Score (0-100)',
                data: {{ sentiment_by_rating | tojson }},
                borderColor: '#64b5f6',
                backgroundColor: 'rgba(100, 181, 246, 0.1)',
                tension: 0.4,
                pointBackgroundColor: '#64b5f6',
                fill: true
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom',
                labels: {
                  padding: 20,
                  usePointStyle: true
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                max: 100,
                grid: {
                  color: 'rgba(255, 255, 255, 0.05)',
                  drawBorder: false
                },
                ticks: {
                  color: '#bdc1c6',
                  callback: function(value) {
                    return value + '%';
                  }
                }
              },
              x: {
                grid: {
                  color: 'rgba(255, 255, 255, 0.05)',
                  drawBorder: false
                },
                ticks: {
                  color: '#bdc1c6'
                }
              }
            }
          }
        });
        </script>
      {% else %}
        <div class="empty-state">
          <h2>No Analytics Data Available</h2>
          <p>Analyze some products to see detailed insights and charts here.</p>
          <a href="/" class="btn-primary">Analyze Product</a>
        </div>
      {% endif %}
    </div>

  </div>

  <script>
    // Animation on page load
    document.addEventListener('DOMContentLoaded', function() {
      const header = document.querySelector('header');
      const statsCards = document.querySelectorAll('.stat-card');
      const charts = document.querySelectorAll('.chart-container');
      
      // Animate header
      if (header) {
        header.style.transform = 'translateY(-30px)';
        header.style.opacity = '0';
        setTimeout(() => {
          header.style.transition = 'all 0.6s ease';
          header.style.transform = 'translateY(0)';
          header.style.opacity = '1';
        }, 100);
      }
      
      // Animate stats cards with stagger
      statsCards.forEach((card, index) => {
        card.style.transform = 'scale(0.8)';
        card.style.opacity = '0';
        setTimeout(() => {
          card.style.transition = 'all 0.5s cubic-bezier(0.4, 0, 0.2, 1)';
          card.style.transform = 'scale(1)';
          card.style.opacity = '1';
        }, 200 + (index * 100));
      });
      
      // Animate charts
      charts.forEach((chart, index) => {
        chart.style.transform = 'translateY(30px)';
        chart.style.opacity = '0';
        setTimeout(() => {
          chart.style.transition = 'all 0.6s ease';
          chart.style.transform = 'translateY(0)';
          chart.style.opacity = '1';
        }, 600 + (index * 200));
      });
    });
  </script>
</body>
</html>